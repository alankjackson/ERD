---
title: "Read FEMA Flood Data"
author: "Alan Jackson"
format: html
editor: source
---

##        Read a Parquet file downloaded from FEMA

https://www.fema.gov/openfema-data-page/fima-nfip-redacted-claims-v2




```{r setup}

library(tidyverse)

pq_path <- "/home/ajackson/Dropbox/Rprojects/ERD/Data/"


```

##        Set up connection to file and pull out Harris county

```{r}
FEMA <- arrow::open_dataset(paste0(pq_path,"FimaNfipClaims.parquet"))

FEMA_Harris <- FEMA %>% 
  filter(countyCode=="48201") %>% 
  collect()

saveRDS(FEMA_Harris, paste0(pq_path, "FEMA_Harris_Flood.rds"))

```

##        Create an event code

```{r}

Fema_clean <- FEMA_Harris %>% 
  select(dateOfLoss, ratedFloodZone, occupancyType, amountPaidOnBuildingClaim,
         yearOfLoss, buildingDamageAmount, buildingPropertyValue,
         buildingReplacementCost, causeOfDamage, floodEvent, waterDepth,
         floodZoneCurrent, censusTract, censusBlockGroupFips,
         nfipCommunityName) %>% 
  arrange(dateOfLoss) %>% 
  


```

##        Look at data

```{r}

foobar <- FEMA_Harris %>%
  filter(censusTract=="48201343700") %>% 
  select(dateOfLoss, ratedFloodZone, occupancyType, amountPaidOnBuildingClaim,
         yearOfLoss, buildingDamageAmount, buildingPropertyValue,
         buildingReplacementCost, causeOfDamage, floodEvent, waterDepth,
         floodZoneCurrent, censusTract, censusBlockGroupFips,
         nfipCommunityName) %>% 
  filter(occupancyType %in% c(1,2,3,11,12,13,14,15))

###   occupancy types
# 1=single family residence; 
# 2 = 2 to 4 unit residential building; 
# 3 = residential building with more than 4 units; 
# 4 = Non-residential building; 
# 6 = Non Residential - Business; 
# 11 = Single-family residential building with the exception of a mobile home or a single residential unit within a multi unit building; 
# 12 = A residential non-condo building with 2, 3, or 4 units seeking insurance on all units; 
# 13 = A residential non-condo building with 5 or more units seeking insurance on all units; 
# 14 = Residential mobile/manufactured home; 
# 15 = Residential condo association seeking coverage on a building with one or more units; 
# 16 = Single residential unit within a multi-unit building; 
# 17 = Non-residential mobile/manufactured home; 
# 18 = A non-residential building; 
# 19 = a non-residential unit within a multi-unit building;

```

##        Combine with census block data

```{r}

#   Get block data for Harris county

library(tidycensus)

census_api_key("c458095036ca1037f97b9c7019b6a7ac2dbf90d4")

#   All these by block group
acs_vars_b <- c(Pop_blk_grp="B01001_001", # Total population by blk grp
              Med_inc="B19013_001", # median household income, blk grp
              Per_cap_inc="B19301_001", # Per capita income, blk grp
              Aggreg_inc="B19025_001", # Aggregate household income, blk grp
              Med_age="B01002_001") # median age, blk grp

ACS_b <- get_acs(geography="block group",
               variables=acs_vars_b,
               year=2020,
               state="TX",
               county="201",
               output="wide",
               geometry=TRUE) 

Sum_per_blk <- FEMA_Harris %>% 
  group_by(censusBlockGroupFips) %>% 
    summarise(Num_Claims=n(),
              Num_dates=n_distinct(dateOfLoss))

FEMA_2 <- inner_join(Sum_per_blk, ACS_b, by=join_by("censusBlockGroupFips"=="GEOID")) %>%
  sf::st_as_sf() %>% 
  sf::st_make_valid() %>% 
  mutate(Claims_percap=Num_Claims/Pop_blk_grpE) %>% 
  filter(Pop_blk_grpE>0)

#   make a diagnostic map

tmap::tmap_options(basemaps="OpenStreetMap")

tmap::tmap_mode("view") # set mode to interactive plots

tmap::tm_shape(FEMA_2) + 
    #tmap::tm_sf(col="ConvoColor", alpha=0.3) +
  # tmap::tm_fill(col = "Num_Claims", title = "Number of Flood Claims", alpha=0.6, style="pretty")+
  tmap::tm_fill(col = "Claims_percap", title = "Flood Claims per capita", alpha=0.6, style="pretty")+
  tmap::tm_borders(lwd=0.1) 

```





